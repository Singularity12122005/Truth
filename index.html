<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>逻辑的边界 – 修正版原型</title>
<style>
:root{
 --bg:#0F1115; --canvas-bg:#111827; --text:#E5E7EB; --border:#374151;
 --accent:#3B82F6; --hl:#FBBF24; --err:#EF4444; --ok:#10B981; --gray:#4A5568;
}
html,body{margin:0;height:100%;display:flex;align-items:center;justify-content:center;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--text);overflow:hidden}
#game-container{position:relative;background:var(--canvas-bg);box-shadow:0 0 32px rgba(0,0,0,.7);border:1px solid var(--border)}
#game-container.frozen .ui-interactive{pointer-events:none;opacity:.45}
#game-canvas{display:block;border:1px solid var(--border);outline:none}
#ui-panel{position:absolute;top:16px;left:16px;background:rgba(15,17,21,.9);backdrop-filter:blur(6px);border:1px solid var(--border);border-radius:10px;padding:14px 16px;display:flex;flex-direction:column;gap:10px;width:230px;user-select:none}
#ui-panel h2{margin:0 0 6px;font-size:17px;border-bottom:1px solid var(--border);padding-bottom:6px}
.sub-label{font-size:11px;text-transform:uppercase;color:#9CA3AF;letter-spacing:.4px;margin-top:4px}
.color-palette{display:flex;flex-wrap:wrap;gap:6px}
.color-palette button{width:34px;height:34px;border-radius:50%;border:2px solid var(--text);cursor:pointer;transition:transform .15s,box-shadow .15s}
.color-palette button:hover{transform:scale(1.15)}
.color-palette button.selected{border-color:var(--hl);box-shadow:0 0 12px var(--hl);transform:scale(1.1)}
#op-panel{display:flex;flex-direction:column;gap:6px}
#op-panel button{padding:6px;border-radius:6px;font-size:12px;letter-spacing:.3px;background:#1F2937;border:1px solid var(--border);color:var(--text);cursor:pointer;transition:background .18s}
#op-panel button.active{background:var(--accent);border-color:var(--accent)}
#op-panel button:not(:disabled):hover{background:#2563EB}
#message-bar{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);min-width:260px;max-width:78vw;padding:10px 22px;background:rgba(15,17,21,.93);backdrop-filter:blur(6px);border:1px solid var(--border);border-radius:10px;font-size:14px;text-align:center;display:flex;flex-direction:column;gap:8px}
#message-bar.error{color:var(--err);border-color:var(--err)}
#message-bar.success{color:var(--ok);border-color:var(--ok)}
#next-level-btn{background:var(--ok);border:none;color:#fff;border-radius:6px;padding:6px 14px;cursor:pointer;font-size:13px}
#history{max-height:120px;overflow:auto;background:#0B0D10;border:1px solid var(--border);border-radius:6px;padding:6px;font-size:11px;line-height:1.2;}
#history::-webkit-scrollbar{width:6px}#history::-webkit-scrollbar-thumb{background:#1F2937;border-radius:3px}
</style>
</head>
<body>
<div id="game-container">
  <canvas id="game-canvas" tabindex="0"></canvas>
  <div id="ui-panel" role="complementary">
   <h2 id="level-name"></h2>
   <div class="sub-label">颜色</div>
   <div id="color-palette" class="color-palette ui-interactive" role="radiogroup"></div>
   <div class="sub-label">算子</div>
   <div id="op-panel" class="ui-interactive"></div>
   <div class="sub-label">历史</div>
   <div id="history"></div>
   <button id="undo-btn" class="ui-interactive" style="margin-top:6px">撤销 (Undo)</button>
  </div>
  <div id="message-bar" role="status"><span id="msg"></span></div>
</div>

<script type="module">
/************** SECTION 0: CONSTANTS **************/
const COLORS = Object.freeze({
  C1:{id:'C1',hex:'#3B82F6',name:'蓝'},
  C2:{id:'C2',hex:'#10B981',name:'绿'},
  C3:{id:'C3',hex:'#F59E0B',name:'黄'},
  C4:{id:'C4',hex:'#EF4444',name:'红'}
});
const COLOR_IDS = Object.keys(COLORS);

/************** SECTION 1: LEVEL DATA **************/
const LEVELS=[{
 id:'L1',name:'归纳之手',objective:'移除度≤5国家。',
 graph:{
  vertices:[{id:0,x:.5,y:.5},{id:1,x:.5,y:.2},{id:2,x:.82,y:.6},{id:3,x:.18,y:.6},{id:4,x:.18,y:.2}],
  countries:{100:[0,1,2,3],101:[1],[102:[2]],[103:[3]],[104:[0,4]]},
  embedding:{100:[101,102,103],101:[100],102:[100],103:[100],104:[]}
 },
 initialColoring:{101:'C1',102:'C2',103:'C3'},
 win(state){return state.graph.countries.size===4;}
}];
/************** SECTION 2: STATE BUILDERS **************/
function buildVertices(arr){return new Map(arr.map(v=>[v.id,{id:v.id,position:{x:v.x,y:v.y}}]));}
function buildCountries(obj){return new Map(Object.entries(obj).map(([k,v])=>[+k,v]));}
function buildEmbedding(obj){return new Map(Object.entries(obj).map(([k,v])=>[+k,v]));}
function deriveEdges(countries){const s=new Set;for(const poly of countries.values()){for(let i=0;i<poly.length;i++){const a=poly[i],b=poly[(i+1)%poly.length];const key=(a<b)?`${a}-${b}`:`${b}-${a}`;s.add(key);}}return s;}
function bboxForCountry(poly,vert){let mnx=1,mny=1,mxx=0,mxy=0;for(const vid of poly){const p=vert.get(vid).position;mnx=Math.min(mnx,p.x);mny=Math.min(mny,p.y);mxx=Math.max(mxx,p.x);mxy=Math.max(mxy,p.y);}return{minX:mnx,minY:mny,maxX:mxx,maxY:mxy};}
function buildBBoxes(countries,verts){const m=new Map;for(const [cid,poly] of countries) m.set(cid,bboxForCountry(poly,verts));return m;}
function mkState(level){const vertices=buildVertices(level.graph.vertices);const countries=buildCountries(level.graph.countries);const embedding=buildEmbedding(level.graph.embedding);const edges=deriveEdges(countries);const boxes=buildBBoxes(countries,vertices);return{level,graph:{vertices,countries,embedding,edges,boxes},coloring:new Map(Object.entries(level.initialColoring||{}).map(([k,v])=>[+k,v])),ui:{mode:'PLAY',selectedColor:'C1',msg:level.objective,error:false,op:null,cutCandidate:null},history:[]};}
/************** SECTION 3: PURE OPERATORS **************/
const Ops={
 isLegal(st,cid,color){for(const n of st.graph.embedding.get(cid)||[]){if(st.coloring.get(n)===color) return false;}return true;},
 snapshot(st){return{coloring:new Map(st.coloring),ui:{...st.ui}};},
 assign(st,cid){const color=st.ui.selectedColor;if(!this.isLegal(st,cid,color))return {...st,ui:{...st.ui,msg:'与邻国同色',error:true}};const nc=new Map(st.coloring);nc.set(cid,color);return{...st,coloring:nc,history:[...st.history,this.snapshot(st)],ui:{...st.ui,msg:`${cid}→${COLORS[color].name}`,error:false}};},
 computeMinDegree(st){let min=1e9,node=null;for(const [cid,neis]of st.graph.embedding){if(neis.length<min){min=neis.length;node=cid;}}return node;},
 cutPrepare(st){const target=this.computeMinDegree(st);return{...st,ui:{...st.ui,op:'CUT',cutCandidate:target,msg:`请选择国家 ${target} 虚化`,error:false}};},
 cutExec(st,cid){if(cid!==st.ui.cutCandidate)return {...st,ui:{...st.ui,msg:`需选择 ${st.ui.cutCandidate}`,error:true}};const snap=this.snapshot(st);const newCountries=new Map(st.graph.countries);newCountries.delete(cid);const newEmbedding=new Map;for(const[ id,neis]of st.graph.embedding){if(id===cid)continue;newEmbedding.set(id,neis.filter(n=>n!==cid));}
 const newEdges=deriveEdges(newCountries);const newBoxes=buildBBoxes(newCountries,st.graph.vertices);return{...st,graph:{...st.graph,countries:newCountries,embedding:newEmbedding,edges:newEdges,boxes:newBoxes},history:[...st.history,snap],ui:{mode:'PLAY',selectedColor:st.ui.selectedColor,msg:`已虚化 ${cid}`,error:false,op:null,cutCandidate:null}};},
 undo(st){if(!st.history.length)return st;const last=st.history[st.history.length-1];return{...st,coloring:last.coloring,ui:{...last.ui,msg:'已撤销',error:false},history:st.history.slice(0,-1)}}
};
/************** SECTION 4: RENDERER **************/
const Renderer={
 init(canvas){this.canvas=canvas;this.ctx=canvas.getContext('2d');this.dpr=window.devicePixelRatio||1;this.resize();},
 resize(){const c=this.canvas,p=c.parentElement;const side=Math.min(p.clientWidth,p.clientHeight,800);this.logical=side;this.ctx.setTransform(1,0,0,1,0,0);c.style.width=c.style.height=side+'px';c.width=c.height=side*this.dpr;this.ctx.scale(this.dpr,this.dpr);},
 draw(st){const ctx=this.ctx,S=this.logical;ctx.clearRect(0,0,S,S);for(const[ cid,poly]of st.graph.countries){ctx.beginPath();poly.forEach((vid,i)=>{const v=st.graph.vertices.get(vid).position;const x=v.x*S,y=v.y*S;i?ctx.lineTo(x,y):ctx.moveTo(x,y);});ctx.closePath();ctx.fillStyle=st.coloring.get(cid)?COLORS[st.coloring.get(cid)].hex:'#4A5568';ctx.fill();}
 ctx.strokeStyle='#E5E7EB';ctx.lineWidth=1.4;ctx.lineJoin='round';for(const e of st.graph.edges){const[ u,v]=e.split('-').map(Number);const p1=st.graph.vertices.get(u).position,p2=st.graph.vertices.get(v).position;ctx.beginPath();ctx.moveTo(p1.x*S,p1.y*S);ctx.lineTo(p2.x*S,p2.y*S);ctx.stroke();}}
};
/************** SECTION 5: UI BUILDERS **************/
function buildPalette(){const root=document.getElementById('color-palette');COLOR_IDS.forEach(id=>{const b=document.createElement('button');b.dataset.color=id;b.style.backgroundColor=COLORS[id].hex;b.setAttribute('role','radio');root.appendChild(b);});}
function buildOps(){const ops=[{id:'ASSIGN',txt:'染色 (Assign)'},{id:'CUT',txt:'虚化之触 (Cut)'}];const panel=document.getElementById('op-panel');ops.forEach(o=>{const b=document.createElement('button');b.dataset.op=o.id;b.textContent=o.txt;panel.appendChild(b);});}
/************** SECTION 6: CONTROLLER **************/
class Game{constructor(canvas,levels){this.canvas=canvas;this.levels=levels;Renderer.init(canvas);this.load(0);}load(idx){this.idx=idx;this.state=mkState(this.levels[idx]);this.bind();this.paint();}
 bind(){// remove old listener if exists
 if(this._click){this.canvas.removeEventListener('click',this._click);}this._click=this.onClick.bind(this);this.canvas.addEventListener('click',this._click);
 document.getElementById('color-palette').onclick=e=>{if(e.target.tagName==='BUTTON'){this.state={...this.state,ui:{...this.state.ui,selectedColor:e.target.dataset.color}};this.paint();}}
 document.getElementById('undo-btn').onclick=()=>{this.state=Ops.undo(this.state);this.paint();}
 document.getElementById('op-panel').onclick=e=>{if(e.target.tagName==='BUTTON'){const op=e.target.dataset.op;if(op==='CUT')this.state=Ops.cutPrepare(this.state);this.paint();}}
 window.addEventListener('resize',()=>{Renderer.resize();this.paint();},{passive:true});}
 onClick(e){const rect=this.canvas.getBoundingClientRect();const norm={x:(e.clientX-rect.left)/rect.width,y:(e.clientY-rect.top)/rect.height};let hit=null;for(const[ cid,box]of this.state.graph.boxes){if(norm.x>=box.minX&&norm.x<=box.maxX&&norm.y>=box.minY&&norm.y<=box.maxY){const poly=this.state.graph.countries.get(cid).map(vid=>this.state.graph.vertices.get(vid).position);if(pointInPoly(norm,poly)){hit=cid;break;}}}
 if(hit===null)return;switch(this.state.ui.op){case 'CUT':this.state=Ops.cutExec(this.state,hit);break;default:this.state=Ops.assign(this.state,hit);}this.checkWin();this.paint();}
 checkWin(){if(this.state.level.win(this.state)){this.state.ui.mode='WIN';document.getElementById('msg').insertAdjacentHTML('beforeend','<button id="next-level-btn">下一关</button>');document.getElementById('next-level-btn').onclick=()=>this.load(this.idx+1);} }
 paint(){Renderer.draw(this.state);document.getElementById('level-name').textContent=this.state.level.name;document.getElementById('msg').textContent=this.state.ui.msg;document.getElementById('message-bar').classList.toggle('error',this.state.ui.error);document.getElementById('color-palette').querySelectorAll('button').forEach(b=>b.classList.toggle('selected',b.dataset.color===this.state.ui.selectedColor));document.getElementById('game-container').classList.toggle('frozen',this.state.ui.mode==='WIN');document.getElementById('history').textContent=`steps:${this.state.history.length}`;}}
/************** UTIL poly **************/
function pointInPoly(p,poly){let inside=false;for(let i=0,j=poly.length-1;i<poly.length;j=i++){const xi=poly[i].x,yi=poly[i].y,xj=poly[j].x,yj=poly[j].y;if(((yi>p.y)!==(yj>p.y))&&(p.x<(xj-xi)*(p.y-yi)/(yj-yi+1e-12)+xi))inside=!inside;}return inside;}
/************** INIT **************/
buildPalette();buildOps();
const game=new Game(document.getElementById('game-canvas'),LEVELS);
</script>
</body>
</html>
