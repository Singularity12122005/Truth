<!DOCTYPE html>
<html lang="zh-CN" class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>å››è‰²å®šç†äº¤äº’å¼è¯æ˜</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* åŸºæœ¬æ ·å¼ä¸åŠ¨ç”» */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    .control-panel button.active { box-shadow:0 0 0 3px rgba(59,130,246,0.5); }
    .toast { transition:opacity .3s,transform .3s; }
    .toast.hide { opacity:0; transform:translateY(20px) translateX(-50%); }
    .node-group:hover>circle { transform:scale(1.1); transition:transform .15s; }
    .kempe-chain-highlight { stroke:#f59e0b!important; stroke-width:5px!important; stroke-dasharray:8 4; animation:dash 1s linear infinite; }
    @keyframes dash { to{stroke-dashoffset:-24;} }
  </style>
</head>
<body class="flex flex-col md:flex-row h-screen overflow-hidden">

  <!-- ä¸»ç”»å¸ƒ -->
  <main class="flex-1 flex items-center justify-center p-4">
    <svg id="graphCanvas" width="100%" height="100%" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid meet"></svg>
  </main>

  <!-- æ§åˆ¶é¢æ¿ -->
  <aside class="w-full md:w-64 bg-white dark:bg-gray-800 p-4 border-t md:border-t-0 md:border-l border-gray-200 dark:border-gray-700 shadow-lg flex flex-col">
    <h1 class="text-xl font-bold mb-2">å››è‰²å®šç†è¯æ˜</h1>
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">ä½“éªŒä»åŸºç¡€åˆ°æ ¸å¿ƒçš„å½¢å¼åŒ–æ¼”ç»</p>
    <div id="tutorial-box" class="text-xs bg-blue-50 dark:bg-blue-900/50 text-blue-800 dark:text-blue-200 p-3 rounded-lg mb-4 min-h-[60px]"></div>
    <div id="actions-box" class="control-panel flex-1 space-y-2"></div>
    <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 space-y-3">
      <h2 class="text-sm font-semibold text-gray-600 dark:text-gray-300">é€‰é¡¹</h2>
      <label class="flex items-center justify-between text-sm cursor-pointer">
        <span>ç¬æ—¶è½¬æ¢</span>
        <input type="checkbox" id="instantToggle" class="toggle-switch sr-only peer">
        <div class="w-11 h-6 bg-gray-200 peer-checked:bg-blue-600 rounded-full relative transition-colors"></div>
      </label>
      <label class="flex items-center justify-between text-sm cursor-pointer">
        <span>è‰²ç›²æ¨¡å¼ (å›¾æ¡ˆ)</span>
        <input type="checkbox" id="patternToggle" class="toggle-switch sr-only peer">
        <div class="w-11 h-6 bg-gray-200 peer-checked:bg-blue-600 rounded-full relative transition-colors"></div>
      </label>
    </div>
    <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
      <button id="undoBtn" class="text-sm px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600" disabled>æ’¤å› (Ctrl+Z)</button>
      <button id="redoBtn" class="text-sm px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded hover:bg-gray-300 dark:hover:bg-gray-600" disabled>é‡åš (Ctrl+Y)</button>
    </div>
  </aside>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-xl text-sm opacity-0 transform translate-y-5 hide"></div>

  <script>
  /************************************************************************
   * 1. ENGINE CORE                                                       *
   ************************************************************************/
  (function(exports) {
    'use strict';
    const SAVE_KEY = '4color_save_v6';
    const DEBUG = new URLSearchParams(location.search).get('debug')==='true';

    function deepClone(obj, hash=new WeakMap()) {
      if (Object(obj)!==obj) return obj;
      if (hash.has(obj)) return hash.get(obj);
      let result;
      if (obj instanceof Map) { result=new Map(); hash.set(obj,result); obj.forEach((v,k)=>result.set(deepClone(k,hash),deepClone(v,hash))); return result; }
      if (obj instanceof Set) { result=new Set(); hash.set(obj,result); obj.forEach(v=>result.add(deepClone(v,hash))); return result; }
      if (Array.isArray(obj)) { result=[]; hash.set(obj,result); obj.forEach((v,i)=>result[i]=deepClone(v,hash)); return result; }
      if (obj instanceof Date) return new Date(obj);
      result={}; hash.set(obj,result);
      for(const k in obj) if(obj.hasOwnProperty(k)) result[k]=deepClone(obj[k],hash);
      return result;
    }

    function saveState(s) {
      try { localStorage.setItem(SAVE_KEY, JSON.stringify(s)); }
      catch(e){ console.error('ä¿å­˜å¤±è´¥',e); }
    }
    function loadState() {
      try { return JSON.parse(localStorage.getItem(SAVE_KEY)||'null'); }
      catch{ return null; }
    }
    function clearState(){ localStorage.removeItem(SAVE_KEY); }

    class Graph {
      constructor(nodes, edges) {
        this.nodes = nodes.map(n=>({...n}));
        this.edges = edges.map(e=>[...e]);
        this.adj = new Map();
        this.nodes.forEach(n=>this.adj.set(n.id,new Set()));
        this.edges.forEach(([u,v])=>{ this.adj.get(u).add(v); this.adj.get(v).add(u); });
      }
      degree(id){ return this.adj.get(id)?.size||0; }
      neighbors(id){ return [...(this.adj.get(id)||[])]; }
      getNode(id){ return this.nodes.find(n=>n.id===id); }
      clone(){ return new Graph(this.nodes,this.edges); }
    }

    // å¯¼å‡ºè‡³å…¨å±€ï¼šè§£å†³ L3 ä¸­ä½œç”¨åŸŸé—®é¢˜
    window.getKempeChain = (G,c,start,k1,k2=>{
      const q=[start], vis=new Set([start]), chain=[];
      while(q.length){
        const u=q.shift(); chain.push(u);
        for(const v of G.neighbors(u)){
          if(!vis.has(v)&&(c[v]===k1||c[v]===k2)){
            vis.add(v); q.push(v);
          }
        }
      }
      return chain;
    });

    const ACTIONS = {
      COLOR_VERTEX: 'COLOR_VERTEX',
      SELECT_KEMPE_PAIR: 'SELECT_KEMPE_PAIR',
      FLIP_KEMPE: 'FLIP_KEMPE',
      _SET_UI_STATE: '_SET_UI_STATE'
    };

    const Graphs = {
      L1_COLORING: {
        nodes:[{id:0,x:250,y:300},{id:1,x:400,y:300},{id:2,x:550,y:300}],
        edges:[[0,1],[1,2]]
      },
      L2_INDUCTION: {
        nodes:[{id:0,x:300,y:200},{id:1,x:500,y:200},{id:2,x:500,y:400},{id:3,x:300,y:400},{id:4,x:400,y:300}],
        edges:[[0,1],[1,2],[2,3],[3,0],[0,4],[1,4],[2,4],[3,4]],
        vStar:4,
        // ä¿®æ­£ presetï¼šé‚»å±…é¢œè‰² {1,2,3,1} â†’ å”¯ä¸€å¯ç”¨ color=4
        preset:{0:1,1:2,2:3,3:1,4:0}
      },
      L3_KEMPE: {
        nodes:[{id:0,x:400,y:150},{id:1,x:550,y:300},{id:2,x:400,y:450},{id:3,x:250,y:300},{id:4,x:400,y:300},{id:5,x:320,y:150},{id:6,x:480,y:150}],
        edges:[[0,4],[1,4],[2,4],[3,4],[0,5],[0,6],[5,6]],
        vStar:4,
        preset:{0:1,1:2,2:3,3:4,4:0,5:2,6:3}
      },
      L4_REDUCTION: {
        nodes:[
          {id:0,x:400,y:100},{id:1,x:300,y:200},{id:2,x:500,y:200},{id:3,x:400,y:250},
          {id:4,x:300,y:350},{id:5,x:500,y:350},{id:6,x:400,y:400},{id:7,x:400,y:500}
        ],
        edges:[[0,1],[0,2],[1,3],[2,3],[1,4],[3,4],[3,5],[2,5],[4,6],[5,6],[6,7]]
      }
    };

    class GameEngine {
      constructor(saved=null) {
        this.subs=[];
        this.history=[];
        this.redoStack=[];
        const loaded = saved||loadState();
        this.state = loaded||this._bootstrap();
        if(DEBUG){ window.__GE__=this; console.log('Debugæ¨¡å¼'); }
      }
      _bootstrap(){
        const g=new Graph(Graphs.L1_COLORING.nodes,Graphs.L1_COLORING.edges);
        const c={}; g.nodes.forEach(n=>c[n.id]=0);
        return { layer:'L1_COLORING', sigma:{G:g,c:c}, uiState:{currentColor:1,instant:false,usePattern:false} };
      }
      subscribe(fn){ this.subs.push(fn); }
      _notify(action){ this.subs.forEach(fn=>fn(this.state,action)); }
      dispatch(action){
        const prev=deepClone(this.state);
        const next=_transition(prev,action);
        // ä»…å½“çœŸçš„å˜æ›´æ—¶è®°å½•å†å²
        if(JSON.stringify(next)!==JSON.stringify(this.state)){
          this.history.push(this.state);
          this.redoStack=[];
          this.state=next;
        }
        this._notify(action);
        saveState(this.state);
      }
      undo(){
        if(this.history.length===0) return;
        this.redoStack.push(this.state);
        this.state=this.history.pop();
        this._notify({type:'__UNDO__'});
        saveState(this.state);
      }
      redo(){
        if(this.redoStack.length===0) return;
        this.history.push(this.state);
        this.state=this.redoStack.pop();
        this._notify({type:'__REDO__'});
        saveState(this.state);
      }
    }

    function _transition(state, action) {
      const s = deepClone(state);
      const { layer, sigma, uiState } = s;
      if(action.type===ACTIONS._SET_UI_STATE){
        return {...s, uiState:{...uiState,...action.payload}};
      }
      const Ïƒ = deepClone(sigma);
      switch(action.type){
        case ACTIONS.COLOR_VERTEX:
          Ïƒ.c[action.payload.v]=action.payload.k; break;
        case ACTIONS.SELECT_KEMPE_PAIR:
          Ïƒ.kempePair=action.payload.pair; break;
        case ACTIONS.FLIP_KEMPE:
          const [a,b]=Ïƒ.kempePair;
          action.payload.chain.forEach(v=>{
            Ïƒ.c[v] = Ïƒ.c[v]===a?b:a;
          });
          Ïƒ.kempePair=null;
          break;
        default:
          console.warn('æœªçŸ¥ Action:',action);
      }
      // Properness æ£€æŸ¥
      for(const [u,v] of Ïƒ.G.edges){
        if(Ïƒ.c[u]!==0 && Ïƒ.c[u]===Ïƒ.c[v]){
          throw new Error('éæ³•ç€è‰²ï¼šç›¸é‚»é¡¶ç‚¹é¢œè‰²å†²çª');
        }
      }
      // æ£€æŸ¥æ˜¯å¦è¾¾æˆæœ¬å±‚ç›®æ ‡
      const goals = {
        L1_COLORING: Ïƒ=>Object.values(Ïƒ.c).every(x=>x!==0),
        L2_INDUCTION: Ïƒ=>Ïƒ.c[Graphs.L2_INDUCTION.vStar]!==0,
        L3_KEMPE: Ïƒ=>Ïƒ.c[Graphs.L3_KEMPE.vStar]!==0,
        L4_REDUCTION: ()=>false
      };
      if(goals[layer] && goals[layer](Ïƒ)){
        // è‡ªåŠ¨æ¨è¿›åˆ°ä¸‹ä¸€å±‚
        const order=['L1_COLORING','L2_INDUCTION','L3_KEMPE','L4_REDUCTION','Z_WIN'];
        const idx=order.indexOf(layer);
        const next=order[idx+1];
        let nextSigma;
        switch(next){
          case 'L2_INDUCTION':
            nextSigma={
              G:new Graph(Graphs.L2_INDUCTION.nodes,Graphs.L2_INDUCTION.edges),
              c: deepClone(Graphs.L2_INDUCTION.preset),
              vStar:Graphs.L2_INDUCTION.vStar
            };
            break;
          case 'L3_KEMPE':
            nextSigma={
              G:new Graph(Graphs.L3_KEMPE.nodes,Graphs.L3_KEMPE.edges),
              c: deepClone(Graphs.L3_KEMPE.preset),
              vStar:Graphs.L3_KEMPE.vStar,
              kempePair:null
            };
            break;
          case 'L4_REDUCTION':
            const g4=new Graph(Graphs.L4_REDUCTION.nodes,Graphs.L4_REDUCTION.edges);
            const c4={}; g4.nodes.forEach(n=>c4[n.id]=0);
            nextSigma={G:g4,c:c4};
            break;
          case 'Z_WIN':
            nextSigma={};
            break;
          default:
            nextSigma=Ïƒ;
        }
        return { layer:next, sigma:nextSigma, uiState };
      }
      return { layer, sigma:Ïƒ, uiState };
    }

    exports.GameEngine=GameEngine;
    exports.ACTIONS=ACTIONS;
    exports.clearState=clearState;
  })(window);
  </script>

  <script>
  /************************************************************************
   * 2. RENDERER & UI                                                     *
   ************************************************************************/
  (function(){
    'use strict';
    const svg = d3.select('#graphCanvas');
    const toastEl = document.getElementById('toast');
    let toastTimeout;

    function pushToast(msg,type='info'){
      clearTimeout(toastTimeout);
      toastEl.textContent=msg;
      toastEl.className='fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg text-sm shadow-xl transition-all';
      toastEl.classList.add(type==='error'?'bg-red-600':'bg-gray-900');
      toastEl.classList.remove('hide','opacity-0','translate-y-5');
      toastTimeout=setTimeout(()=>{
        toastEl.classList.add('hide','opacity-0','translate-y-5');
      },3000);
    }

    const COLORS = [
      {id:1,fill:'#e74c3c',pattern:'url(#pat-stripes)'},
      {id:2,fill:'#3498db',pattern:'url(#pat-dots)'},
      {id:3,fill:'#2ecc71',pattern:'url(#pat-cross)'},
      {id:4,fill:'#f1c40f',pattern:'url(#pat-grid)'}
    ];
    const COLOR_ZERO='#bdc3c7';

    // åˆå§‹åŒ– patterns
    (()=>{
      if(svg.select('defs').empty()){
        const defs=svg.append('defs');
        const addPat=(id,d,sw=1)=>{
          const p=defs.append('pattern').attr('id',id).attr('patternUnits','userSpaceOnUse').attr('width',8).attr('height',8);
          p.append('rect').attr('width',8).attr('height',8).attr('fill','rgba(255,255,255,0.9)');
          p.append('path').attr('d',d).attr('stroke','#333').attr('stroke-width',sw).attr('stroke-linecap','square');
        };
        addPat('pat-stripes','M-2,2 L2,-2 M0,8 L8,0 M6,10 L10,6');
        addPat('pat-dots','M2,2 H2 V2 M6,6 H6 V6',2);
        addPat('pat-cross','M0,0L8,8 M8,0L0,8');
        addPat('pat-grid','M4,0 V8 M0,4 H8');
      }
    })();

    function getFill(k,ui){
      if(k===0) return COLOR_ZERO;
      const c=COLORS.find(x=>x.id===k);
      return ui.usePattern?c.pattern:c.fill;
    }

    const RENDERERS={};

    function render(state,action){
      if(!state) return;
      const {layer,sigma,uiState}=state;
      const fn=RENDERERS[layer]||RENDERERS.Z_WIN;
      try{
        fn(sigma,uiState);
        updateTutorial(layer);
        updateUndoRedo();
        if(action?.type==='__ERROR__') pushToast(action.payload,'error');
      }catch(e){
        console.error('æ¸²æŸ“é”™è¯¯',e);
        pushToast('æ¸²æŸ“æ—¶å‡ºé”™ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°','error');
      }
    }

    function createRenderer(layerId){
      return (Ïƒ,ui)=>{
        svg.selectAll('*').remove();
        const G=Ïƒ.G, c=Ïƒ.c, vStar=Ïƒ.vStar, kp=Ïƒ.kempePair;

        // è¾¹
        svg.append('g').selectAll('line').data(G.edges).join('line')
          .attr('x1',d=>G.getNode(d[0]).x).attr('y1',d=>G.getNode(d[0]).y)
          .attr('x2',d=>G.getNode(d[1]).x).attr('y2',d=>G.getNode(d[1]).y)
          .attr('stroke','#9ca3af').attr('stroke-width',3);

        // èŠ‚ç‚¹
        const ng=svg.append('g').selectAll('g').data(G.nodes,d=>d.id).join(
          enter=>{
            const g=enter.append('g').attr('class','node-group').style('opacity',0);
            g.append('circle').attr('r',24).attr('stroke','#374151').attr('stroke-width',2);
            g.append('text').attr('text-anchor','middle').attr('dy','.35em').attr('fill','#1f2937').text(d=>d.id);
            g.transition().duration(ui.instant?0:200).style('opacity',1);
            return g;
          }
        );
        ng.attr('transform',d=>`translate(${d.x},${d.y})`).style('cursor','pointer')
          .on('click',(e,d)=>{
            if(layerId==='L3_KEMPE'&&kp){
              const chain=window.getKempeChain(G,c,d.id,kp[0],kp[1]);
              ENGINE.dispatch({type:ACTIONS.FLIP_KEMPE,payload:{chain}});
            }else{
              ENGINE.dispatch({type:ACTIONS.COLOR_VERTEX,payload:{v:d.id,k:ui.currentColor}});
            }
          });

        // Kempeé“¾é«˜äº®
        if(layerId==='L3_KEMPE'){
          ng.on('mouseover',(e,d)=>{
            if(!Ïƒ.kempePair) return;
            const [a,b]=Ïƒ.kempePair, chain=new Set(window.getKempeChain(G,c,d.id,a,b));
            ng.select('circle').classed('kempe-chain-highlight',n=>chain.has(n.id));
          }).on('mouseout',()=>ng.select('circle').classed('kempe-chain-highlight',false));
        }

        // å¡«å…… & è¾¹æ¡†
        ng.select('circle')
          .attr('stroke',d=>d.id===vStar?'#0ea5e9':'#374151')
          .attr('stroke-width',d=>d.id===vStar?4:2)
          .attr('stroke-dasharray',d=>d.id===vStar?'6 3':null)
          .transition().duration(ui.instant?0:200)
          .attr('fill',d=>getFill(c[d.id],ui));

        drawActions(layerId,Ïƒ,ui);
      };
    }

    RENDERERS.L1_COLORING = createRenderer('L1_COLORING');
    RENDERERS.L2_INDUCTION = createRenderer('L2_INDUCTION');
    RENDERERS.L3_KEMPE     = createRenderer('L3_KEMPE');
    RENDERERS.L4_REDUCTION = createRenderer('L4_REDUCTION');
    RENDERERS.Z_WIN        = (Ïƒ,ui)=>{
      svg.selectAll('*').remove();
      const t=svg.append('text').attr('x','50%').attr('y','50%')
        .attr('text-anchor','middle').attr('dominant-baseline','middle');
      t.append('tspan').attr('x','50%').attr('dy','-0.5em').attr('font-size','48px').attr('fill','#10b981').text('ğŸ‰');
      t.append('tspan').attr('x','50%').attr('dy','1.2em').attr('font-size','24px').attr('font-weight','bold').text('è¯æ˜å®Œæˆ');
      t.append('tspan').attr('x','50%').attr('dy','1.5em').attr('font-size','16px').attr('fill','#6b7280').text('æ‚¨å·²æŒæ¡å››è‰²å®šç†æ ¸å¿ƒæ€æƒ³ã€‚');
      drawActions('Z_WIN',Ïƒ,ui);
    };

    const tutorials = {
      L1_COLORING:'L1ï¼šåŸºç¡€ç€è‰²â€”â€”ä¸ºæ‰€æœ‰é¡¶ç‚¹ç€è‰²ï¼Œç›¸é‚»ä¸åŒè‰²ã€‚',
      L2_INDUCTION:'L2ï¼šå½’çº³æ³•â€”â€”æ–°é¡¶ç‚¹å”¯ä¸€å¯é€‰é¢œè‰²4ï¼Œè¯·é€‰è‰²åç‚¹å‡»å®ƒã€‚',
      L3_KEMPE:'L3ï¼šKempeé“¾â€”â€”é€‰ä¸€å¯¹é¢œè‰²ï¼Œç‚¹å‡»é“¾ä¸Šé¡¶ç‚¹ç¿»è½¬ã€‚',
      L4_REDUCTION:'L4ï¼šæœ€åæŒ‘æˆ˜â€”â€”å¤æ‚å›¾ä¸­å®Œæˆå››è‰²è¯æ˜ã€‚',
      Z_WIN:'æ­å–œï¼æ‚¨å®Œæˆäº†äº¤äº’å¼å››è‰²å®šç†è¯æ˜ã€‚'
    };
    function updateTutorial(layer){
      document.getElementById('tutorial-box').textContent = tutorials[layer]||'';
    }

    const actionsBox = document.getElementById('actions-box');
    function drawActions(layer,Ïƒ,ui){
      actionsBox.innerHTML='';
      const makePalette=()=>{
        const cDiv=document.createElement('div'); cDiv.className='grid grid-cols-2 gap-2';
        COLORS.forEach(col=>{
          const btn=document.createElement('button');
          btn.className='w-full py-2 rounded-md text-white font-semibold';
          btn.style.backgroundColor=col.fill;
          btn.textContent=`é¢œè‰² ${col.id}`;
          btn.onclick=()=>ENGINE.dispatch({type:ACTIONS._SET_UI_STATE,payload:{currentColor:col.id}});
          if(ui.currentColor===col.id) btn.classList.add('ring-2','ring-blue-500');
          cDiv.appendChild(btn);
        });
        actionsBox.appendChild(cDiv);
      };

      switch(layer){
        case 'L1_COLORING':
        case 'L2_INDUCTION':
        case 'L4_REDUCTION':
          makePalette(); break;

        case 'L3_KEMPE':
          makePalette();
          const grid=document.createElement('div');
          grid.className='grid grid-cols-3 gap-2 mt-4';
          const pairs=[];
          for(let i=0;i<COLORS.length;i++){
            for(let j=i+1;j<COLORS.length;j++){
              pairs.push([COLORS[i],COLORS[j]]);
            }
          }
          pairs.forEach(([c1,c2])=>{
            const b=document.createElement('button');
            b.className='w-full h-8 border-2 rounded-md flex items-center justify-center gap-1';
            b.innerHTML=`<div class="w-4 h-4 rounded-full" style="background:${c1.fill}"></div>
                         <div class="w-4 h-4 rounded-full" style="background:${c2.fill}"></div>`;
            b.onclick=()=>ENGINE.dispatch({type:ACTIONS.SELECT_KEMPE_PAIR,payload:{pair:[c1.id,c2.id]}});
            if(Ïƒ.kempePair && Ïƒ.kempePair[0]===c1.id && Ïƒ.kempePair[1]===c2.id){
              b.classList.add('border-blue-500','ring-2','ring-blue-500');
            } else {
              b.classList.add('border-gray-300');
            }
            grid.appendChild(b);
          });
          actionsBox.appendChild(grid);
          break;

        case 'Z_WIN':
          const btn=document.createElement('button');
          btn.className='w-full bg-green-600 text-white py-2 rounded-md font-bold';
          btn.textContent='é‡æ–°å¼€å§‹';
          btn.onclick=()=>{ clearState(); location.reload(); };
          actionsBox.appendChild(btn);
          break;
      }
    }

    function updateUndoRedo(){
      document.getElementById('undoBtn').disabled = ENGINE.history.length===0;
      document.getElementById('redoBtn').disabled = ENGINE.redoStack.length===0;
    }

    document.getElementById('instantToggle').onchange = e=>{
      ENGINE.dispatch({type:ACTIONS._SET_UI_STATE,payload:{instant:e.target.checked}});
    };
    document.getElementById('patternToggle').onchange = e=>{
      ENGINE.dispatch({type:ACTIONS._SET_UI_STATE,payload:{usePattern:e.target.checked}});
    };
    document.getElementById('undoBtn').onclick = ()=>ENGINE.undo();
    document.getElementById('redoBtn').onclick = ()=>ENGINE.redo();
    window.addEventListener('keydown',e=>{
      if((e.ctrlKey||e.metaKey)&&e.key==='z'){ e.preventDefault(); ENGINE.undo(); }
      if((e.ctrlKey||e.metaKey)&&e.key==='y'){ e.preventDefault(); ENGINE.redo(); }
    });

    const ENGINE = new window.GameEngine();
    ENGINE.subscribe(render);
    render(ENGINE.state);

  })();
  </script>
</body>
</html>
